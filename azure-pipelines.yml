# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
- main

pool:
  vmImage: 'windows-latest'

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
  - stage: 'Build'
    displayName: 'Build'
    jobs:
    - job: 'Build'
      displayName: 'Build'
      pool:
        name: REDACTED
      variables:
        Solution: '**/*.sln'
        BuildPlatform: 'Any CPU'
        BuildConfiguration: 'Release'
      steps:
      - task: NuGetToolInstaller@1
        displayName: 'Install NuGet Tools'
      - task: NuGetCommand@2
        displayName: 'Restore NuGet Packages'
        inputs:
          restoreSolution: '$(Solution)'
      - task: VSBuild@1
        displayName: 'MSBuild'
        inputs:
          solution: '$(Solution)'
          msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=false /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(Build.ArtifactStagingDirectory)\$(ArtifactPackageName)"'
          platform: '$(BuildPlatform)'
          configuration: '$(BuildConfiguration)'
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Build Artifacts'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: drop
          publishLocation: 'Container'
          
  - stage: 'Deploy'
    displayName: 'Deploy'
    dependsOn: 'Build'
    jobs:
    - deployment: 'Deploy'
      displayName: 'Deploy'
      continueOnError: false
      timeoutInMinutes: 10
      workspace:
        clean: all
      pool:
        name: REDACTED
      environment:
        name: SERVER-DEV
        resourceType: VirtualMachine
      strategy:
        runOnce:
          deploy:
            steps:
              - task: PowerShell@2
                inputs:
                 targetType: 'inline'
                 script: 
                  Write-Host "Hello World"
                  Start-Sleep -Seconds 20
                  Write-Host "Hello World"
            